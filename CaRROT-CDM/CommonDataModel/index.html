
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.18">
    
    
      
        <title>CommonDataModel - Carrot Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="carrot" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#destination-tables" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Carrot Docs" class="md-header__button md-logo" aria-label="Carrot Docs" data-md-component="logo">
      
  <img src="../../images/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Carrot Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              CommonDataModel
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Health-Informatics-UoN/carrot-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Health-Informatics-UoN/carrot-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Carrot Docs" class="md-nav__button md-logo" aria-label="Carrot Docs" data-md-component="logo">
      
  <img src="../../images/favicon.png" alt="logo">

    </a>
    Carrot Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Health-Informatics-UoN/carrot-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Health-Informatics-UoN/carrot-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#destination-tables" class="md-nav__link">
    <span class="md-ellipsis">
      Destination Tables
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Destination Tables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generating-more-tables" class="md-nav__link">
    <span class="md-ellipsis">
      Generating More Tables
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#destination-fields" class="md-nav__link">
    <span class="md-ellipsis">
      Destination Fields
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel" class="md-nav__link">
    <span class="md-ellipsis">
      CommonDataModel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.__setitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __setitem__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.add" class="md-nav__link">
    <span class="md-ellipsis">
      add
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.close" class="md-nav__link">
    <span class="md-ellipsis">
      close
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.count_objects" class="md-nav__link">
    <span class="md-ellipsis">
      count_objects
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.from_existing" class="md-nav__link">
    <span class="md-ellipsis">
      from_existing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.get_objects" class="md-nav__link">
    <span class="md-ellipsis">
      get_objects
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.keys" class="md-nav__link">
    <span class="md-ellipsis">
      keys
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.mask_person_id" class="md-nav__link">
    <span class="md-ellipsis">
      mask_person_id
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.objects" class="md-nav__link">
    <span class="md-ellipsis">
      objects
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.process" class="md-nav__link">
    <span class="md-ellipsis">
      process
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.process_simult" class="md-nav__link">
    <span class="md-ellipsis">
      process_simult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.process_table" class="md-nav__link">
    <span class="md-ellipsis">
      process_table
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.set_indexing" class="md-nav__link">
    <span class="md-ellipsis">
      set_indexing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carrot.cdm.model.CommonDataModel.set_outfile_separator" class="md-nav__link">
    <span class="md-ellipsis">
      set_outfile_separator
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/Health-Informatics-UoN/carrot-docs/edit/main/docs/CaRROT-CDM/CommonDataModel.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


  <h1>CommonDataModel</h1>

<p>The Pythonic version of the CommonDataModel is built object-orientated in the subfolder <code>carrot/cdm/</code>:
<div class="highlight"><pre><span></span><code>carrot/cdm/
├── __init__.py
├── decorators.py
├── model.py
├── objects
│   ├── __init__.py
│   ├── common.py
│   └── versions
│       ├── __init__.py
│       └── v5_3_1
│           ├── __init__.py
│           ├── condition_occurrence.py
│           ├── drug_exposure.py
│           ├── measurement.py
│           ├── observation.py
│           ├── person.py
│           ├── procedure_occurrence.py
│           ├── specimen.py
│           └── visit_occurrence.py
</code></pre></div></p>
<h2 id="destination-tables">Destination Tables<a class="headerlink" href="#destination-tables" title="Permanent link">&para;</a></h2>
<p>All CDM destination tables are formed as objects and are defined in <code>carrot/cdm/objects</code>, inheriting from a base class (<code>DestinationTable</code>, defined in <code>common.py</code>):</p>
<ul>
<li><a href="../Person/">Person</a></li>
<li><a href="../ConditionOccurrence/">Condition Occurrence</a></li>
<li><a href="../VisitOccurrence/">Visit Occurrence</a></li>
<li><a href="../Observation/">Observation</a></li>
<li><a href="../Measurement/">Measurement</a></li>
<li><a href="../DrugExposure/">Drug Exposure</a></li>
<li><a href="../ProcedureOccurrence/">Procedure Occurrence</a></li>
<li><a href="../Specimen/">Specimen</a></li>
</ul>
<h3 id="generating-more-tables">Generating More Tables<a class="headerlink" href="#generating-more-tables" title="Permanent link">&para;</a></h3>
<p>The package contains <code>.csv</code> dumps taken from BCLink that give descriptions of what fields are contained within each CDM table.</p>
<p>At present are only dumps from version <code>5.3.1</code> of the CDM:</p>
<div class="highlight"><pre><span></span><code>$ ls $(carrot info data_folder)/cdm/BCLINK_EXPORT/5.3.1
export-CONDITION_OCCURRENCE.csv export-MEASUREMENT.csv          export-PERSON.csv
export-DRUG_EXPOSURE.csv        export-OBSERVATION.csv
</code></pre></div>
<p>To help generate a pythonic template for a CDM template, the CLI can be used to do this
<div class="highlight"><pre><span></span><code>carrot generate cdm drug_exposure 5.3.1
</code></pre></div>
This command tool outputs the following code that you could use to copy, paster and edit to create a new table for <code>drug_exposure</code>
<div class="highlight"><pre><span></span><code><span class="bp">self</span><span class="o">.</span><span class="n">drug_exposure_id</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">person_id</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">drug_concept_id</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">drug_exposure_start_date</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">drug_exposure_start_datetime</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">drug_exposure_end_date</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">drug_exposure_end_datetime</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">verbatim_end_date</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">drug_type_concept_id</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">stop_reason</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Text20&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">refills</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Float&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">days_supply</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">route_concept_id</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">lot_number</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Text50&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">provider_id</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">visit_occurrence_id</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">drug_source_value</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Text50&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">drug_source_concept_id</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Integer&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">route_source_value</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Text50&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">dose_unit_source_value</span> <span class="o">=</span> <span class="n">DestinationField</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Text50&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</code></pre></div></p>
<h2 id="destination-fields">Destination Fields<a class="headerlink" href="#destination-fields" title="Permanent link">&para;</a></h2>
<p>In <code>common.py</code> a class called <code>DestinationField</code> defines how to handle an input pandas series.
This pandas series is effectively a column in the output of the CDM Tables, in other words, <code>DestinationField</code> is an object for the <code>destination_field</code>, e.g. <code>person_id</code> in the <code>destination_table</code> <code>person</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DestinationField</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="n">required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="n">pk</span>
</code></pre></div>
<ul>
<li><code>self.series</code>: initialises as <code>None</code> and will hold a <code>pandas.Series</code> object if the column is to be filled in the output.    </li>
<li><code>self.dtype</code>: specifies a string for handling how to format the output of this column so it's in the right format when saved to the final <code>.csv</code> to be uploaded successfully to a BCLink.  </li>
<li><code>self.required</code>:  if the <code>destination_field</code> is required (<code>True</code>), any rows of the final table that do not have this column filled (<code>None</code>, <code>NaN</code>), are removed (dropped) from the output.</li>
<li><code>self.pk</code>: specifies if this column is the <strong>primary key</strong> for its associated table. This can be used to order the tables based on this.</li>
</ul>


<div class="doc doc-object doc-class">



<a id="carrot.cdm.model.CommonDataModel"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="carrot.tools.logger.Logger" href="../Logger/#carrot.tools.logger.Logger">Logger</a></code></p>


        <p>Pythonic Version of the OHDSI CDM.</p>
<p>This class controls and manages CDM Table objects that are added to it</p>
<p>When self.process() is executed by the user, all added objects are defined, merged, formatted and finalised, before being dumped to an output file (.tsv file by default).</p>

              <details class="quote">
                <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
                <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CommonDataModel</span><span class="p">(</span><span class="n">Logger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pythonic Version of the OHDSI CDM.</span>

<span class="sd">    This class controls and manages CDM Table objects that are added to it</span>

<span class="sd">    When self.process() is executed by the user, all added objects are defined, merged, formatted and finalised, before being dumped to an output file (.tsv file by default).</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">inputs</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;save_files&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;do_mask_person_id&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;format_level&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
        <span class="n">default_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cdm</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">default_kwargs</span><span class="p">)</span>
        <span class="n">cdm</span><span class="o">.</span><span class="n">_load_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cdm</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_rules</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">rules</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cdm</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cdm</span><span class="o">.</span><span class="n">create_and_add_objects</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cdm</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">omop_version</span><span class="o">=</span><span class="s1">&#39;5.3.1&#39;</span><span class="p">,</span>
                 <span class="n">outputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">save_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">use_profiler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">format_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">do_mask_person_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">automatically_fill_missing_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommonDataModel class initialisation </span>
<span class="sd">        Args:</span>
<span class="sd">            name (str): Give a name for the class to appear in the logging</span>
<span class="sd">            output_folder (str): Path of where the output tsv/csv files should be written to.</span>
<span class="sd">                                 The default is to save to a folder in the current directory</span>
<span class="sd">                                 called &#39;output_data&#39;.</span>
<span class="sd">            inputs (dict or DataCollection): inputs can be a dictionary mapping file names to pandas dataframes,</span>
<span class="sd">                                        or can be a DataCollection object</span>
<span class="sd">            use_profiler (bool): Turn on/off profiling of the CPU/Memory of running the current process. </span>
<span class="sd">                                 The default is set to false.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;::&quot;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CommonDataModel (</span><span class="si">{</span><span class="n">omop_version</span><span class="si">}</span><span class="s2">) created with co-connect-tools version </span><span class="si">{</span><span class="n">carrot_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">omop_version</span> <span class="o">=</span> <span class="n">omop_version</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_duplicates</span> <span class="o">=</span> <span class="n">drop_duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_mask_person_id</span> <span class="o">=</span> <span class="n">do_mask_person_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">format_level</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">format_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">format_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">format_level</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You as specifying format_level=&#39;</span><span class="si">{</span><span class="n">format_level</span><span class="si">}</span><span class="s2">&#39; -- this should be an integer!&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;format_level not set as an int &quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">format_level</span> <span class="o">=</span> <span class="n">FormatterLevel</span><span class="p">(</span><span class="n">format_level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_files</span> <span class="o">=</span> <span class="n">save_files</span>

        <span class="k">if</span> <span class="n">use_profiler</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Turning on cpu/memory profiling&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span> <span class="o">=</span> <span class="n">Profiler</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1">#perform some checks on the input data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running with an DataCollection object&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="n">DataCollection</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running with an DataCollection object&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">raise</span> <span class="n">BadInputObject</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input object </span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s2"> is of type </span><span class="si">{</span><span class="n">_type</span><span class="si">}</span><span class="s2">, which is not a valid input object&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;inputs&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;overwriting inputs&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;inputs&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#register opereation tools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">OperationTools</span><span class="p">()</span>

        <span class="c1">#allow rules to be generated automatically or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">automatically_fill_missing_columns</span> <span class="o">=</span> <span class="n">automatically_fill_missing_columns</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automatically_fill_missing_columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Turning on automatic cdm column filling&quot;</span><span class="p">)</span>

        <span class="c1">#define a person_id masker, if the person_id are to be masked</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">load_global_ids</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">load_indexing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#stores the final pandas dataframe for each CDM object</span>
        <span class="c1"># {</span>
        <span class="c1">#   &#39;person&#39;:pandas.DataFrame,</span>
        <span class="c1">#   &#39;measurement&#39;:pandas.DataFrame.</span>
        <span class="c1">#   ....</span>
        <span class="c1">#}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#stores the invididual objects associated to this model</span>
        <span class="c1"># {</span>
        <span class="c1">#     &#39;observation&#39;:</span>
        <span class="c1">#     {</span>
        <span class="c1">#         &#39;observation_0&#39;: &lt;carrot.cdm.objects.observation.Observation object 0x000&gt;,</span>
        <span class="c1">#         &#39;observation_1&#39;: &lt;carrot.cdm.objects.observation.Observation object 0x001&gt;,</span>
        <span class="c1">#     },</span>
        <span class="c1">#     &#39;measurement&#39;:</span>
        <span class="c1">#     {</span>
        <span class="c1">#         &#39;measurement_0&#39;: &lt;carrot.cdm.objects.measurement.Measurement object 0x000&gt;,</span>
        <span class="c1">#         ...</span>
        <span class="c1">#     }</span>
        <span class="c1">#     ...</span>
        <span class="c1"># }</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#check if objects have already been registered with this class</span>
        <span class="c1">#via the decorator methods</span>

        <span class="n">registered_objects</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">DestinationTable</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1">#if they have, then include them in this model</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">registered_objects</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__analyses</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">analysis</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">#bookkeep some logs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;meta&#39;</span><span class="p">:{</span>
                <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">carrot_version</span><span class="p">,</span>
                <span class="s1">&#39;created_by&#39;</span><span class="p">:</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">(),</span>
                <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">()),</span>
                <span class="s1">&#39;dataset&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;total_data_processed&#39;</span><span class="p">:{}</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">destination_table</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">get_cdm_class</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span><span class="n">destination_table</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not loading </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">, this is not a valid CDM Table&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_df</span><span class="p">(</span><span class="n">force_rebuild</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_objects</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">load_global_ids</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">load_indexing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span> <span class="o">=</span> <span class="kc">None</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class destructor:</span>
<span class="sd">              Stops the profiler from running before deleting self</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">],</span><span class="n">indent</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">write_meta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">finalise</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;profiler&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">df_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">get_df</span><span class="p">()</span>
            <span class="n">f_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span>
            <span class="n">f_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f_out</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">logs</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f_out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;making output folder </span><span class="si">{</span><span class="n">f_out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f_out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f_out</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">statistics_</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
            <span class="n">df_profile</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writen the memory/cpu statistics to </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_existing</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the CDM model from existing data in the CDM format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdm</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;inputs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoInputFiles</span><span class="p">(</span><span class="s2">&quot;you need to specify some inputs&quot;</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
        <span class="c1">#loop over all input names</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1">#obtain the name of the destination table</span>
            <span class="c1">#e.g fname=&#39;person.tsv&#39; we want &#39;person&#39;</span>
            <span class="n">destination_table</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">destination_table</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">destination_table</span><span class="p">:</span>
                <span class="n">destination_table</span> <span class="o">=</span> <span class="n">destination_table</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">get_cdm_class</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">cdm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not loading </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">, this is not a valid CDM Table&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">cdm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cdm</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ability lookup processed objects from the CDM</span>
<span class="sd">        Example:</span>
<span class="sd">            cdm = CommonDataModel()</span>
<span class="sd">            ...</span>
<span class="sd">            cdm.process()</span>
<span class="sd">            ...</span>
<span class="sd">            person = cdm[&#39;person&#39;]</span>
<span class="sd">        Args:</span>
<span class="sd">            key (str): The name of the cdm table to be returned</span>
<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame if a processed object is found, otherwise returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registration of a new dataframe for a new object</span>
<span class="sd">        Args:</span>
<span class="sd">            key (str) : name of the CDM table (e.g. &quot;person&quot;)</span>
<span class="sd">            obj (pandas.DataFrame) : dataframe to refer to </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to add a new CDM table (object) to the current model</span>
<span class="sd">        Args:</span>
<span class="sd">            obj (DestinationTable) : CDM Table to be registered with the class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_type</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object called </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">cdm</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">format_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_type</span><span class="p">][</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">create_and_add_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">):</span>
        <span class="c1">#loop over the cdm object types defined in the configuration</span>
        <span class="c1">#e.g person, measurement etc..</span>
        <span class="k">for</span> <span class="n">destination_table</span><span class="p">,</span><span class="n">rules_set</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;cdm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#loop over each object instance in the rule set</span>
            <span class="c1">#for example, condition_occurrence may have multiple rulesx</span>
            <span class="c1">#for multiple condition_ocurrences e.g. Headache, Fever ..</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">rules</span> <span class="ow">in</span> <span class="n">rules_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1">#make a new object for the cdm object</span>
                <span class="c1">#Example:</span>
                <span class="c1"># destination_table : person</span>
                <span class="c1"># get_cdm_class returns &lt;Person&gt;</span>
                <span class="c1"># obj : Person()</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">get_cdm_class</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)()</span>
                <span class="c1">#set the name of the object</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="c1">#Build a lambda function that will get executed during run time</span>
                <span class="c1">#and will be able to apply these rules to the inputs that are loaded</span>
                <span class="c1">#(this is useful when chunk)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">define</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">rules</span><span class="o">=</span><span class="n">rules</span> <span class="p">:</span> <span class="n">carrot</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">apply_rules</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">rules</span><span class="p">,</span><span class="n">inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>

                <span class="c1">#register this object with the CDM model, so it can be processed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">add_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__analyses</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_analyses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__analyses</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__analyses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_analyses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">analyses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">msg</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finished with </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__analyses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start thread for </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="p">{</span><span class="n">futures</span><span class="p">[</span><span class="n">f</span><span class="p">]:{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span><span class="s1">&#39;running&#39;</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">running</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;done&#39;</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;waiting&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]):</span>
                    <span class="k">break</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running analyses took </span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="n">dropna</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="n">dropna</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">filters</span><span class="p">):</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span>
            <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span>
            <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span>
            <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span>
            <span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">eq</span>
        <span class="p">}</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;filter must be a &#39;dict&#39; .&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">op_str</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ops</span><span class="p">[</span><span class="n">op_str</span><span class="p">](</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="n">val</span><span class="p">)]</span>                        
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span><span class="n">spec</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">retval</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">DestinationTable</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">get_df</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">func</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">)]</span>

            <span class="n">retval</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">retval</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">retval</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">retval</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">retval</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">keep</span> <span class="ow">in</span> <span class="n">cols</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">keep</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">retval</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">retval</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">retval</span>


        <span class="c1"># for obj in config:</span>
        <span class="c1">#     if isinstance(obj,str):</span>
        <span class="c1">#         df = self[obj].get_df()</span>
        <span class="c1">#         if df.index.name != &#39;person_id&#39;:</span>
        <span class="c1">#             df = df.set_index(&#39;person_id&#39;)</span>
        <span class="c1">#     elif isinstance(obj,dict):</span>
        <span class="c1">#         for key,value in obj.items():</span>
        <span class="c1">#             print (self[key])</span>
        <span class="c1">#             df = self[key]</span>
        <span class="c1">#             df = self._filter(df,value)</span>
        <span class="c1">#             if df.index.name != &#39;person_id&#39;:</span>
        <span class="c1">#                 df = df.set_index(&#39;person_id&#39;)</span>
        <span class="c1">#             if retval is None:</span>
        <span class="c1">#                 retval = df</span>
        <span class="c1">#             else:</span>
        <span class="c1">#                 retval = retval.merge(df,left_index=True,right_index=True)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         raise NotImplementedError(&quot;need to pass a json object to filter()&quot;)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span> <span class="n">obj</span> <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_start_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">destination_table</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;getting start index for </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no indexing specified, so starting the index for </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2"> from 1&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">destination_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span><span class="p">[</span><span class="n">destination_table</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;indexing configuration has be parsed &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;but this table (</span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">) &quot;</span>
                                <span class="s2">&quot;has not be passed, so starting from 1&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">destination_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">destination_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">destination_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">destination_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a given destination table:</span>
<span class="sd">        * Retrieve all associated objects that have been registered with the class</span>

<span class="sd">        Args:</span>
<span class="sd">            destination_table (str) : name of a destination (CDM) table e.g. &quot;person&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            list : a list of destination table objects </span>
<span class="sd">                   e.g. [&lt;person_0&gt;, &lt;person_1&gt;] </span>
<span class="sd">                   which would be objects for male and female mapping</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">destination_table</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;looking for </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">destination_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to obtain the table &#39;</span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">&#39;, but cannot find any objects&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Something wrong!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">obj</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">mask_person_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">destination_table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a dataframe object, apply a masking map on the person_id, if one has been created</span>
<span class="sd">        Args:</span>
<span class="sd">            df (pandas.Dataframe) : input pandas dataframe</span>
<span class="sd">        Returns:</span>
<span class="sd">            pandas.Dataframe: modified dataframe with person id masked</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;person_id&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1">#if masker has not been defined, define it</span>
            <span class="k">if</span> <span class="n">destination_table</span> <span class="o">==</span> <span class="s1">&#39;person&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">start_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_index</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">person_id_masker</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">start_index</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="p">:</span>
                        <span class="n">existing_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#39; already found in the person_id_masker&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">existing_index</span><span class="si">}</span><span class="s2">&#39; assigned to this already&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;was trying to set &#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Most likely cause is this is duplicate data!&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">PersonExists</span><span class="p">(</span><span class="s1">&#39;Duplicate person found!&#39;</span><span class="p">)</span>
                    <span class="n">person_id_masker</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">person_id_masker</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                    <span class="n">dfp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(((</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="n">person_id_masker</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                                       <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SOURCE_SUBJECT&#39;</span><span class="p">,</span><span class="s1">&#39;TARGET_SUBJECT&#39;</span><span class="p">])</span>

                    <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="k">if</span> <span class="n">new</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;person_ids&quot;</span><span class="p">,</span><span class="n">dfp</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>

            <span class="c1">#apply the masking</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Person ID masking cannot be performed on&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2"> as no masker based on a person table has been defined!&quot;</span><span class="p">)</span>

            <span class="n">nbefore</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">])</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Just masked person_id using integers&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">destination_table</span> <span class="o">!=</span> <span class="s1">&#39;person&#39;</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">nafter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">])</span>
                <span class="n">ndiff</span> <span class="o">=</span> <span class="n">nbefore</span> <span class="o">-</span> <span class="n">nafter</span>
                <span class="n">df</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;valid_person_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;before&#39;</span><span class="p">:</span><span class="n">nbefore</span><span class="p">,</span><span class="s1">&#39;after&#39;</span><span class="p">:</span><span class="n">nafter</span><span class="p">}</span>
                <span class="c1">#if rows have been removed</span>
                <span class="k">if</span> <span class="n">ndiff</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There are person_ids in this table that are not in the output person table!&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Either they are not in the original data, or while creating the person table, &quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;studies have been removed due to lack of required fields, such as birthdate.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nafter</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">nbefore</span><span class="si">}</span><span class="s2"> were good, </span><span class="si">{</span><span class="n">ndiff</span><span class="si">}</span><span class="s2"> studies are removed.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">count_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each CDM (destination) table, count the number of objects associated</span>
<span class="sd">        e.g.</span>
<span class="sd">        {</span>
<span class="sd">           &quot;observation&quot;: 6,</span>
<span class="sd">           &quot;condition_occurrence&quot;: 1,</span>
<span class="sd">           &quot;person&quot;: 2</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count_map</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">},</span><span class="n">indent</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of objects to process for each table...</span><span class="se">\n</span><span class="si">{</span><span class="n">count_map</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For cdm.keys(), return the keys of which objects have been mapped.</span>
<span class="sd">        Hence which CDM table dataframes have been created.</span>
<span class="sd">        This should be used AFTER cdm.process() has been run, which creates the dataframes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to retrieve the input objects to the CDM </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">conserve_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process chunked data, processes as follows</span>
<span class="sd">        * While the chunking of is not yet finished</span>
<span class="sd">        * Loop over all CDM tables (via execution order) </span>
<span class="sd">          and process the table (see process_table), returning a dataframe</span>
<span class="sd">        * Register the retrieve dataframe with the model  </span>
<span class="sd">        * For the current chunk slice, save the data/logs to files</span>
<span class="sd">        * Retrieve the next chunk of data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_execution_order</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting processing in order: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_objects</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">destination_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                
                <span class="n">df_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_table</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="n">object_list</span><span class="p">)</span>
                <span class="n">ntables</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">#print (self.drop_duplicates)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_generator</span><span class="p">):</span>

                    <span class="n">df</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_df</span><span class="p">()</span>
                    <span class="n">ntables</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="n">nrows</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">conserve_memory</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_files</span><span class="p">:</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">first</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_dataframe</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="k">del</span> <span class="n">df</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">conserve_memory</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="c1">#.sort_values(df.columns[0])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_files</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_duplicates</span> <span class="ow">and</span> <span class="n">destination_table</span> <span class="o">!=</span> <span class="s1">&#39;person&#39;</span><span class="p">:</span>
                            <span class="n">nbefore</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                            <span class="n">df_hash</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">hash_pandas_object</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df_hash</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df_hash</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
                            <span class="n">nafter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                            <span class="n">ndiff</span> <span class="o">=</span> <span class="n">nbefore</span> <span class="o">-</span> <span class="n">nafter</span>
                            <span class="k">if</span> <span class="n">ndiff</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">ndiff</span><span class="si">}</span><span class="s2"> row(s) due to duplicates found when merging </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Example duplicates...&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">df_temp</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                        <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">first</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_dataframe</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">):</span>
                            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Int64Dtype</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="bp">self</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>


                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finalised </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s1"> on iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> producing </span><span class="si">{</span><span class="n">nrows</span><span class="si">}</span><span class="s1"> rows from </span><span class="si">{</span><span class="n">ntables</span><span class="si">}</span><span class="s1"> tables&#39;</span><span class="p">)</span>

                <span class="c1">#move onto the next iteration                </span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1">#if inputs are defined, and we havent just finished the last table,</span>
            <span class="c1">#reset the inputs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">destination_table</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1">#for destination_table in self.execution_order:</span>
        <span class="c1">#    index = self.get_start_index(destination_table)</span>
        <span class="c1">#    print (index)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">process_simult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">conserve_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        process simulataneously</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_execution_order</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting processing in order: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_objects</span><span class="p">()</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">destination_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="p">:</span>
                <span class="n">df_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_table</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="n">object_list</span><span class="p">)</span>
                <span class="n">ntables</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_generator</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_df</span><span class="p">()</span>

                    <span class="n">ntables</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="n">nrows</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_files</span><span class="p">:</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_dataframe</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">conserve_memory</span><span class="p">:</span>
                        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                    <span class="c1">#else:</span>
                    <span class="c1">#    obj.clear()</span>
                    <span class="c1">#    del df</span>
                    <span class="c1">#    df = None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">conserve_memory</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_execution_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;person&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_execution_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">order</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span> <span class="o">=</span> <span class="n">order</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">destination_table</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a CDM (destination) table. The method proceeds as follows:</span>
<span class="sd">        * Given a destination table name e.g. &#39;person&#39; </span>
<span class="sd">        * Retrieve all objects belonging to the given CDM table (e.g. &lt;person_0, person_1&gt;)</span>
<span class="sd">        * Loop over each object</span>
<span class="sd">        * Retrieve a dataframe for that object given it&#39;s definition/rules (see get_df)</span>
<span class="sd">        * Concatenate all retrieve dataframes together by stacking on top of each other vertically</span>
<span class="sd">        * Create new indexes for the primary column so the go from 1-N </span>

<span class="sd">        Args:</span>
<span class="sd">            destination_table (str) : name of a destination table to process (e.g. &#39;person&#39;)</span>
<span class="sd">            object_list (list) : [optional] list of objects to process</span>
<span class="sd">        Returns:</span>
<span class="sd">            list(pandas.Dataframe): a dataframes in the CDM format for this destination table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_objects</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">object_list</span><span class="p">:</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">object_list</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">]</span>

        <span class="n">nobjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nobjects</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;s&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;for </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">: found </span><span class="si">{</span><span class="n">nobjects</span><span class="si">}</span><span class="s2"> object</span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">yield</span> <span class="kc">None</span>

        <span class="c1">#execute them all</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;working on </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;objects&#39;</span><span class="p">:{}}</span>

        <span class="k">if</span> <span class="n">destination_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;total_data_processed&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;total_data_processed&#39;</span><span class="p">][</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">nrows_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;total_data_processed&#39;</span><span class="p">][</span><span class="n">destination_table</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objects</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting on </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">start_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_index</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)</span>
            <span class="n">start_index</span> <span class="o">+=</span> <span class="n">nrows_processed</span>

            <span class="c1">#force_rebuild=True,</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_df</span><span class="p">(</span><span class="n">start_index</span><span class="o">=</span><span class="n">start_index</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finished </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">df</span><span class="p">))</span><span class="si">}</span><span class="s2">) &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;... </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span><span class="si">}</span><span class="s2"> completed, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.. no outputs were found &quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mask_person_id</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_person_id</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">destination_table</span><span class="p">)</span>

            <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">nrows_processed</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;total_data_processed&#39;</span><span class="p">][</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrows_processed</span>
            <span class="k">if</span> <span class="n">destination_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="n">destination_table</span><span class="p">][</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span>

            <span class="n">obj</span><span class="o">.</span><span class="n">set_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">obj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saving dataframe (</span><span class="si">{</span><span class="n">_id</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;called save_dateframe but outputs are not defined. save_files: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">save_files</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_person_id_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">person_id_map</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="o">=</span> <span class="n">person_id_map</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_indexing_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indexing</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span> <span class="o">=</span> <span class="n">indexing</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_outfile_separator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set which separator to use, e.g. &#39;,&#39; or &#39;\t&#39; </span>

<span class="sd">        Args:</span>
<span class="sd">            sep (str): which separator to use when writing csv (tsv) files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outfile_separator</span> <span class="o">=</span> <span class="n">sep</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_indexing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index_map</span><span class="p">,</span><span class="n">strict_check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create indexes on input files which would allow rules to use data from </span>
<span class="sd">        different input tables.</span>

<span class="sd">        Args:</span>
<span class="sd">            index_map (dict): a map between the filename and what should be the column used for indexing </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoInputFiles</span><span class="p">(</span><span class="s1">&#39;Trying to indexing before any inputs have been setup&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">index</span> <span class="ow">in</span> <span class="n">index_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;trying to set index &#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; but this has not been loaded as an inputs!&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;trying to set index &#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39; on dataset &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;, but this index is not in the columns! something really wrong!&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span> 
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.__getitem__" class="doc doc-heading">
            <code class=" language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.__getitem__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Ability lookup processed objects from the CDM
Example:
    cdm = CommonDataModel()
    ...
    cdm.process()
    ...
    person = cdm['person']
Args:
    key (str): The name of the cdm table to be returned
Returns:
    pandas.DataFrame if a processed object is found, otherwise returns None</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ability lookup processed objects from the CDM</span>
<span class="sd">    Example:</span>
<span class="sd">        cdm = CommonDataModel()</span>
<span class="sd">        ...</span>
<span class="sd">        cdm.process()</span>
<span class="sd">        ...</span>
<span class="sd">        person = cdm[&#39;person&#39;]</span>
<span class="sd">    Args:</span>
<span class="sd">        key (str): The name of the cdm table to be returned</span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame if a processed object is found, otherwise returns None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.__init__" class="doc doc-heading">
            <code class=" language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">omop_version</span><span class="o">=</span><span class="s1">&#39;5.3.1&#39;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_profiler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">format_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_mask_person_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">automatically_fill_missing_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>CommonDataModel class initialisation 
Args:
    name (str): Give a name for the class to appear in the logging
    output_folder (str): Path of where the output tsv/csv files should be written to.
                         The default is to save to a folder in the current directory
                         called 'output_data'.
    inputs (dict or DataCollection): inputs can be a dictionary mapping file names to pandas dataframes,
                                or can be a DataCollection object
    use_profiler (bool): Turn on/off profiling of the CPU/Memory of running the current process. 
                         The default is set to false.</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">omop_version</span><span class="o">=</span><span class="s1">&#39;5.3.1&#39;</span><span class="p">,</span>
             <span class="n">outputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">save_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">use_profiler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">format_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">do_mask_person_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">automatically_fill_missing_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommonDataModel class initialisation </span>
<span class="sd">    Args:</span>
<span class="sd">        name (str): Give a name for the class to appear in the logging</span>
<span class="sd">        output_folder (str): Path of where the output tsv/csv files should be written to.</span>
<span class="sd">                             The default is to save to a folder in the current directory</span>
<span class="sd">                             called &#39;output_data&#39;.</span>
<span class="sd">        inputs (dict or DataCollection): inputs can be a dictionary mapping file names to pandas dataframes,</span>
<span class="sd">                                    or can be a DataCollection object</span>
<span class="sd">        use_profiler (bool): Turn on/off profiling of the CPU/Memory of running the current process. </span>
<span class="sd">                             The default is set to false.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;::&quot;</span> <span class="o">+</span> <span class="n">name</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CommonDataModel (</span><span class="si">{</span><span class="n">omop_version</span><span class="si">}</span><span class="s2">) created with co-connect-tools version </span><span class="si">{</span><span class="n">carrot_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">omop_version</span> <span class="o">=</span> <span class="n">omop_version</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">drop_duplicates</span> <span class="o">=</span> <span class="n">drop_duplicates</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">do_mask_person_id</span> <span class="o">=</span> <span class="n">do_mask_person_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">format_level</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">format_level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">format_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">format_level</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You as specifying format_level=&#39;</span><span class="si">{</span><span class="n">format_level</span><span class="si">}</span><span class="s2">&#39; -- this should be an integer!&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;format_level not set as an int &quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">format_level</span> <span class="o">=</span> <span class="n">FormatterLevel</span><span class="p">(</span><span class="n">format_level</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_files</span> <span class="o">=</span> <span class="n">save_files</span>

    <span class="k">if</span> <span class="n">use_profiler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Turning on cpu/memory profiling&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span> <span class="o">=</span> <span class="n">Profiler</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1">#perform some checks on the input data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running with an DataCollection object&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="n">DataCollection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running with an DataCollection object&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">raise</span> <span class="n">BadInputObject</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input object </span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s2"> is of type </span><span class="si">{</span><span class="n">_type</span><span class="si">}</span><span class="s2">, which is not a valid input object&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;inputs&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;overwriting inputs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;inputs&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#register opereation tools</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">OperationTools</span><span class="p">()</span>

    <span class="c1">#allow rules to be generated automatically or not</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">automatically_fill_missing_columns</span> <span class="o">=</span> <span class="n">automatically_fill_missing_columns</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automatically_fill_missing_columns</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Turning on automatic cdm column filling&quot;</span><span class="p">)</span>

    <span class="c1">#define a person_id masker, if the person_id are to be masked</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">load_global_ids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">load_indexing</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexing_conf</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#stores the final pandas dataframe for each CDM object</span>
    <span class="c1"># {</span>
    <span class="c1">#   &#39;person&#39;:pandas.DataFrame,</span>
    <span class="c1">#   &#39;measurement&#39;:pandas.DataFrame.</span>
    <span class="c1">#   ....</span>
    <span class="c1">#}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1">#stores the invididual objects associated to this model</span>
    <span class="c1"># {</span>
    <span class="c1">#     &#39;observation&#39;:</span>
    <span class="c1">#     {</span>
    <span class="c1">#         &#39;observation_0&#39;: &lt;carrot.cdm.objects.observation.Observation object 0x000&gt;,</span>
    <span class="c1">#         &#39;observation_1&#39;: &lt;carrot.cdm.objects.observation.Observation object 0x001&gt;,</span>
    <span class="c1">#     },</span>
    <span class="c1">#     &#39;measurement&#39;:</span>
    <span class="c1">#     {</span>
    <span class="c1">#         &#39;measurement_0&#39;: &lt;carrot.cdm.objects.measurement.Measurement object 0x000&gt;,</span>
    <span class="c1">#         ...</span>
    <span class="c1">#     }</span>
    <span class="c1">#     ...</span>
    <span class="c1"># }</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#check if objects have already been registered with this class</span>
    <span class="c1">#via the decorator methods</span>

    <span class="n">registered_objects</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">DestinationTable</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1">#if they have, then include them in this model</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">registered_objects</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__analyses</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">analysis</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">#bookkeep some logs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;meta&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">carrot_version</span><span class="p">,</span>
            <span class="s1">&#39;created_by&#39;</span><span class="p">:</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">(),</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">()),</span>
            <span class="s1">&#39;dataset&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;total_data_processed&#39;</span><span class="p">:{}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.__setitem__" class="doc doc-heading">
            <code class=" language-python"><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.__setitem__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Registration of a new dataframe for a new object
Args:
    key (str) : name of the CDM table (e.g. "person")
    obj (pandas.DataFrame) : dataframe to refer to</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Registration of a new dataframe for a new object</span>
<span class="sd">    Args:</span>
<span class="sd">        key (str) : name of the CDM table (e.g. &quot;person&quot;)</span>
<span class="sd">        obj (pandas.DataFrame) : dataframe to refer to </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.add" class="doc doc-heading">
            <code class=" language-python"><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.add" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Function to add a new CDM table (object) to the current model
Args:
    obj (DestinationTable) : CDM Table to be registered with the class</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to add a new CDM table (object) to the current model</span>
<span class="sd">    Args:</span>
<span class="sd">        obj (DestinationTable) : CDM Table to be registered with the class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_type</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object called </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">cdm</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">format_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_level</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_type</span><span class="p">][</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.close" class="doc doc-heading">
            <code class=" language-python"><span class="n">close</span><span class="p">()</span></code>

<a href="#carrot.cdm.model.CommonDataModel.close" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



<details class="class-destructor" open>
  <summary>Class destructor</summary>
  <p>Stops the profiler from running before deleting self</p>
</details>
            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class destructor:</span>
<span class="sd">          Stops the profiler from running before deleting self</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">],</span><span class="n">indent</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">write_meta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">finalise</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;profiler&#39;</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">df_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">get_df</span><span class="p">()</span>
        <span class="n">f_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span>
        <span class="n">f_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f_out</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">logs</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f_out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;making output folder </span><span class="si">{</span><span class="n">f_out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f_out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f_out</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">statistics_</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
        <span class="n">df_profile</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writen the memory/cpu statistics to </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.count_objects" class="doc doc-heading">
            <code class=" language-python"><span class="n">count_objects</span><span class="p">()</span></code>

<a href="#carrot.cdm.model.CommonDataModel.count_objects" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>For each CDM (destination) table, count the number of objects associated
e.g.
{
   "observation": 6,
   "condition_occurrence": 1,
   "person": 2
}</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">count_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each CDM (destination) table, count the number of objects associated</span>
<span class="sd">    e.g.</span>
<span class="sd">    {</span>
<span class="sd">       &quot;observation&quot;: 6,</span>
<span class="sd">       &quot;condition_occurrence&quot;: 1,</span>
<span class="sd">       &quot;person&quot;: 2</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count_map</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">},</span><span class="n">indent</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of objects to process for each table...</span><span class="se">\n</span><span class="si">{</span><span class="n">count_map</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.from_existing" class="doc doc-heading">
            <code class=" language-python"><span class="n">from_existing</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#carrot.cdm.model.CommonDataModel.from_existing" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initialise the CDM model from existing data in the CDM format</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_existing</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialise the CDM model from existing data in the CDM format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cdm</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;inputs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoInputFiles</span><span class="p">(</span><span class="s2">&quot;you need to specify some inputs&quot;</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
    <span class="c1">#loop over all input names</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#obtain the name of the destination table</span>
        <span class="c1">#e.g fname=&#39;person.tsv&#39; we want &#39;person&#39;</span>
        <span class="n">destination_table</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">destination_table</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">destination_table</span><span class="p">:</span>
            <span class="n">destination_table</span> <span class="o">=</span> <span class="n">destination_table</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">get_cdm_class</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">cdm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not loading </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">, this is not a valid CDM Table&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">cdm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cdm</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.get_objects" class="doc doc-heading">
            <code class=" language-python"><span class="n">get_objects</span><span class="p">(</span><span class="n">destination_table</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.get_objects" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>For a given destination table:
* Retrieve all associated objects that have been registered with the class</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>destination_table</code></td>
            <td>
                  <code>str) </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of a destination (CDM) table e.g. "person"</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    list : a list of destination table objects 
           e.g. [<person_0>, <person_1>] 
           which would be objects for male and female mapping</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">destination_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given destination table:</span>
<span class="sd">    * Retrieve all associated objects that have been registered with the class</span>

<span class="sd">    Args:</span>
<span class="sd">        destination_table (str) : name of a destination (CDM) table e.g. &quot;person&quot;</span>
<span class="sd">    Returns:</span>
<span class="sd">        list : a list of destination table objects </span>
<span class="sd">               e.g. [&lt;person_0&gt;, &lt;person_1&gt;] </span>
<span class="sd">               which would be objects for male and female mapping</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">destination_table</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;looking for </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">destination_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to obtain the table &#39;</span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">&#39;, but cannot find any objects&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Something wrong!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">obj</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.keys" class="doc doc-heading">
            <code class=" language-python"><span class="n">keys</span><span class="p">()</span></code>

<a href="#carrot.cdm.model.CommonDataModel.keys" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>For cdm.keys(), return the keys of which objects have been mapped.
Hence which CDM table dataframes have been created.
This should be used AFTER cdm.process() has been run, which creates the dataframes.</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For cdm.keys(), return the keys of which objects have been mapped.</span>
<span class="sd">    Hence which CDM table dataframes have been created.</span>
<span class="sd">    This should be used AFTER cdm.process() has been run, which creates the dataframes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.mask_person_id" class="doc doc-heading">
            <code class=" language-python"><span class="n">mask_person_id</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">destination_table</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.mask_person_id" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Given a dataframe object, apply a masking map on the person_id, if one has been created
Args:
    df (pandas.Dataframe) : input pandas dataframe
Returns:
    pandas.Dataframe: modified dataframe with person id masked</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mask_person_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">destination_table</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dataframe object, apply a masking map on the person_id, if one has been created</span>
<span class="sd">    Args:</span>
<span class="sd">        df (pandas.Dataframe) : input pandas dataframe</span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.Dataframe: modified dataframe with person id masked</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;person_id&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1">#if masker has not been defined, define it</span>
        <span class="k">if</span> <span class="n">destination_table</span> <span class="o">==</span> <span class="s1">&#39;person&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">start_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_index</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)</span>
                <span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">person_id_masker</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">start_index</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="p">:</span>
                    <span class="n">existing_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#39; already found in the person_id_masker&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">existing_index</span><span class="si">}</span><span class="s2">&#39; assigned to this already&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;was trying to set &#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Most likely cause is this is duplicate data!&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">PersonExists</span><span class="p">(</span><span class="s1">&#39;Duplicate person found!&#39;</span><span class="p">)</span>
                <span class="n">person_id_masker</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">person_id_masker</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="n">dfp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(((</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="n">person_id_masker</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                                   <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SOURCE_SUBJECT&#39;</span><span class="p">,</span><span class="s1">&#39;TARGET_SUBJECT&#39;</span><span class="p">])</span>

                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="k">if</span> <span class="n">new</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;person_ids&quot;</span><span class="p">,</span><span class="n">dfp</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>

        <span class="c1">#apply the masking</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Person ID masking cannot be performed on&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2"> as no masker based on a person table has been defined!&quot;</span><span class="p">)</span>

        <span class="n">nbefore</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">person_id_masker</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Just masked person_id using integers&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">destination_table</span> <span class="o">!=</span> <span class="s1">&#39;person&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">nafter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;person_id&#39;</span><span class="p">])</span>
            <span class="n">ndiff</span> <span class="o">=</span> <span class="n">nbefore</span> <span class="o">-</span> <span class="n">nafter</span>
            <span class="n">df</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;valid_person_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;before&#39;</span><span class="p">:</span><span class="n">nbefore</span><span class="p">,</span><span class="s1">&#39;after&#39;</span><span class="p">:</span><span class="n">nafter</span><span class="p">}</span>
            <span class="c1">#if rows have been removed</span>
            <span class="k">if</span> <span class="n">ndiff</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There are person_ids in this table that are not in the output person table!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Either they are not in the original data, or while creating the person table, &quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;studies have been removed due to lack of required fields, such as birthdate.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nafter</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">nbefore</span><span class="si">}</span><span class="s2"> were good, </span><span class="si">{</span><span class="n">ndiff</span><span class="si">}</span><span class="s2"> studies are removed.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.objects" class="doc doc-heading">
            <code class=" language-python"><span class="n">objects</span><span class="p">()</span></code>

<a href="#carrot.cdm.model.CommonDataModel.objects" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Method to retrieve the input objects to the CDM</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to retrieve the input objects to the CDM </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objects</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.process" class="doc doc-heading">
            <code class=" language-python"><span class="n">process</span><span class="p">(</span><span class="n">object_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conserve_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.process" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Process chunked data, processes as follows
* While the chunking of is not yet finished
* Loop over all CDM tables (via execution order) 
  and process the table (see process_table), returning a dataframe
* Register the retrieve dataframe with the model<br />
* For the current chunk slice, save the data/logs to files
* Retrieve the next chunk of data</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">conserve_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process chunked data, processes as follows</span>
<span class="sd">    * While the chunking of is not yet finished</span>
<span class="sd">    * Loop over all CDM tables (via execution order) </span>
<span class="sd">      and process the table (see process_table), returning a dataframe</span>
<span class="sd">    * Register the retrieve dataframe with the model  </span>
<span class="sd">    * For the current chunk slice, save the data/logs to files</span>
<span class="sd">    * Retrieve the next chunk of data</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_execution_order</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting processing in order: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count_objects</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">destination_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="p">:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                
            <span class="n">df_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_table</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="n">object_list</span><span class="p">)</span>
            <span class="n">ntables</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#print (self.drop_duplicates)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_generator</span><span class="p">):</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_df</span><span class="p">()</span>
                <span class="n">ntables</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="n">nrows</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">conserve_memory</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_files</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">first</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_dataframe</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">df</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">conserve_memory</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="c1">#.sort_values(df.columns[0])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_duplicates</span> <span class="ow">and</span> <span class="n">destination_table</span> <span class="o">!=</span> <span class="s1">&#39;person&#39;</span><span class="p">:</span>
                        <span class="n">nbefore</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                        <span class="n">df_hash</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">hash_pandas_object</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df_hash</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df_hash</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
                        <span class="n">nafter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                        <span class="n">ndiff</span> <span class="o">=</span> <span class="n">nbefore</span> <span class="o">-</span> <span class="n">nafter</span>
                        <span class="k">if</span> <span class="n">ndiff</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">ndiff</span><span class="si">}</span><span class="s2"> row(s) due to duplicates found when merging </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Example duplicates...&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">df_temp</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                    <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">first</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_dataframe</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">):</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Int64Dtype</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finalised </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s1"> on iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> producing </span><span class="si">{</span><span class="n">nrows</span><span class="si">}</span><span class="s1"> rows from </span><span class="si">{</span><span class="n">ntables</span><span class="si">}</span><span class="s1"> tables&#39;</span><span class="p">)</span>

            <span class="c1">#move onto the next iteration                </span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1">#if inputs are defined, and we havent just finished the last table,</span>
        <span class="c1">#reset the inputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">destination_table</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.process_simult" class="doc doc-heading">
            <code class=" language-python"><span class="n">process_simult</span><span class="p">(</span><span class="n">object_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conserve_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.process_simult" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>process simulataneously</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_simult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">conserve_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    process simulataneously</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_execution_order</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting processing in order: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count_objects</span><span class="p">()</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">destination_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_order</span><span class="p">:</span>
            <span class="n">df_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_table</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="n">object_list</span><span class="p">)</span>
            <span class="n">ntables</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_generator</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_df</span><span class="p">()</span>

                <span class="n">ntables</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="n">nrows</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_files</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_dataframe</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">conserve_memory</span><span class="p">:</span>
                    <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="c1">#else:</span>
                <span class="c1">#    obj.clear()</span>
                <span class="c1">#    del df</span>
                <span class="c1">#    df = None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">conserve_memory</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.process_table" class="doc doc-heading">
            <code class=" language-python"><span class="n">process_table</span><span class="p">(</span><span class="n">destination_table</span><span class="p">,</span> <span class="n">object_list</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.process_table" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Process a CDM (destination) table. The method proceeds as follows:
* Given a destination table name e.g. 'person' 
* Retrieve all objects belonging to the given CDM table (e.g. <person_0, person_1>)
* Loop over each object
* Retrieve a dataframe for that object given it's definition/rules (see get_df)
* Concatenate all retrieve dataframes together by stacking on top of each other vertically
* Create new indexes for the primary column so the go from 1-N </p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>destination_table</code></td>
            <td>
                  <code>str) </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of a destination table to process (e.g. 'person')</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>object_list</code></td>
            <td>
                  <code>list) </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>[optional] list of objects to process</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    list(pandas.Dataframe): a dataframes in the CDM format for this destination table</p>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">destination_table</span><span class="p">,</span><span class="n">object_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a CDM (destination) table. The method proceeds as follows:</span>
<span class="sd">    * Given a destination table name e.g. &#39;person&#39; </span>
<span class="sd">    * Retrieve all objects belonging to the given CDM table (e.g. &lt;person_0, person_1&gt;)</span>
<span class="sd">    * Loop over each object</span>
<span class="sd">    * Retrieve a dataframe for that object given it&#39;s definition/rules (see get_df)</span>
<span class="sd">    * Concatenate all retrieve dataframes together by stacking on top of each other vertically</span>
<span class="sd">    * Create new indexes for the primary column so the go from 1-N </span>

<span class="sd">    Args:</span>
<span class="sd">        destination_table (str) : name of a destination table to process (e.g. &#39;person&#39;)</span>
<span class="sd">        object_list (list) : [optional] list of objects to process</span>
<span class="sd">    Returns:</span>
<span class="sd">        list(pandas.Dataframe): a dataframes in the CDM format for this destination table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_objects</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">object_list</span><span class="p">:</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">object_list</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">]</span>

    <span class="n">nobjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nobjects</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;s&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;for </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">: found </span><span class="si">{</span><span class="n">nobjects</span><span class="si">}</span><span class="s2"> object</span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">yield</span> <span class="kc">None</span>

    <span class="c1">#execute them all</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;working on </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;objects&#39;</span><span class="p">:{}}</span>

    <span class="k">if</span> <span class="n">destination_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;total_data_processed&#39;</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;total_data_processed&#39;</span><span class="p">][</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">nrows_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;total_data_processed&#39;</span><span class="p">][</span><span class="n">destination_table</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objects</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting on </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">start_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_index</span><span class="p">(</span><span class="n">destination_table</span><span class="p">)</span>
        <span class="n">start_index</span> <span class="o">+=</span> <span class="n">nrows_processed</span>

        <span class="c1">#force_rebuild=True,</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_df</span><span class="p">(</span><span class="n">start_index</span><span class="o">=</span><span class="n">start_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finished </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">df</span><span class="p">))</span><span class="si">}</span><span class="s2">) &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;... </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span><span class="si">}</span><span class="s2"> completed, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.. no outputs were found &quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_mask_person_id</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_person_id</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">destination_table</span><span class="p">)</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">nrows_processed</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;total_data_processed&#39;</span><span class="p">][</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrows_processed</span>
        <span class="k">if</span> <span class="n">destination_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="n">destination_table</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="n">destination_table</span><span class="p">][</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">set_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">obj</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.set_indexing" class="doc doc-heading">
            <code class=" language-python"><span class="n">set_indexing</span><span class="p">(</span><span class="n">index_map</span><span class="p">,</span> <span class="n">strict_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.set_indexing" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create indexes on input files which would allow rules to use data from 
different input tables.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>index_map</code></td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a map between the filename and what should be the column used for indexing</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_indexing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index_map</span><span class="p">,</span><span class="n">strict_check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create indexes on input files which would allow rules to use data from </span>
<span class="sd">    different input tables.</span>

<span class="sd">    Args:</span>
<span class="sd">        index_map (dict): a map between the filename and what should be the column used for indexing </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoInputFiles</span><span class="p">(</span><span class="s1">&#39;Trying to indexing before any inputs have been setup&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">index</span> <span class="ow">in</span> <span class="n">index_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;trying to set index &#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39; for &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; but this has not been loaded as an inputs!&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;trying to set index &#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39; on dataset &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;, but this index is not in the columns! something really wrong!&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span> 
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="carrot.cdm.model.CommonDataModel.set_outfile_separator" class="doc doc-heading">
            <code class=" language-python"><span class="n">set_outfile_separator</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span></code>

<a href="#carrot.cdm.model.CommonDataModel.set_outfile_separator" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Set which separator to use, e.g. ',' or '       ' </p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>sep</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>which separator to use when writing csv (tsv) files</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docs/CaRROT-CDM/source_code/carrot/cdm/model.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_outfile_separator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set which separator to use, e.g. &#39;,&#39; or &#39;\t&#39; </span>

<span class="sd">    Args:</span>
<span class="sd">        sep (str): which separator to use when writing csv (tsv) files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_outfile_separator</span> <span class="o">=</span> <span class="n">sep</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
 
        
      </div>
      <div class="md-social">
  
</div>
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.tracking", "navigation.indexes", "navigation.top", "content.action.edit"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3220b9d7.min.js"></script>
      
    
  </body>
</html>