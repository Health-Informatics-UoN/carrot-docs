
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.18">
    
    
      
        <title>RunningLocally - Carrot Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="carrot" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Carrot Docs" class="md-header__button md-logo" aria-label="Carrot Docs" data-md-component="logo">
      
  <img src="../../images/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Carrot Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              RunningLocally
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Health-Informatics-UoN/carrot-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Health-Informatics-UoN/carrot-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Carrot Docs" class="md-nav__button md-logo" aria-label="Carrot Docs" data-md-component="logo">
      
  <img src="../../images/favicon.png" alt="logo">

    </a>
    Carrot Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Health-Informatics-UoN/carrot-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Health-Informatics-UoN/carrot-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-functions-basics" class="md-nav__link">
    <span class="md-ellipsis">
      Azure Functions Basics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Azure Functions Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#azure-functions-in-carrot-mapper" class="md-nav__link">
    <span class="md-ellipsis">
      Azure Functions in Carrot-Mapper
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-functions-queues" class="md-nav__link">
    <span class="md-ellipsis">
      Azure Functions Queues
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-azure-functions-locally" class="md-nav__link">
    <span class="md-ellipsis">
      Running Azure Functions Locally
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running Azure Functions Locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-an-nlp-task" class="md-nav__link">
    <span class="md-ellipsis">
      Running an NLP task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stopping-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      Stopping Debugging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/Health-Informatics-UoN/carrot-docs/edit/main/docs/AzureFunctions/RunningLocally.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


  <h1>RunningLocally</h1>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page is for developers of Azure Functions - not users</p>
</div>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Running Azure Functions locally is a little involved; this guide has been written to get you up and running 
with Azure CLI and Functions. Note that this guide assumes you're using VSCode. All of the functionality 
described here can be replicated outside of VSCode (in Azure CLI) but instructions for doing so are not 
detailed in this guide.</p>
<blockquote>
<p>Note that this guide is not intended to demonstrate how to create an Azure Function from scratch. 
Its purpose is to show you how to run pre-coded Functions.</p>
</blockquote>
<p>To follow this guide you need to install <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a>.</p>
<h2 id="azure-functions-basics">Azure Functions Basics<a class="headerlink" href="#azure-functions-basics" title="Permanent link">&para;</a></h2>
<p>Conceptually, queue-based Azure Functions are simple to follow. A <strong><em>message</em></strong> is posted to a <strong><em>message queue</em></strong>. 
A Function then executes on messages within a message queue. In Carrot-Mapper, a message is posted to a message 
queue as JSON but other formats are possible (e.g. XML). Here's an example message destined for the <code>scanreports</code> queue:</p>
<div class="highlight"><pre><span></span><code>{
  &quot;scan_report_id&quot;: 105, 
  &quot;blob_name&quot;: &quot;GOSH_CoStar_WhiteRabbit_MetaData_V24_T29kygl.xlsx&quot;
}
</code></pre></div>
<p>And here is an example message destined for the <code>nlpqueue</code> queue:</p>
<div class="highlight"><pre><span></span><code>{
  &quot;documents&quot;: 
  [{
    &quot;language&quot;: &quot;en&quot;, 
    &quot;id&quot;: &quot;17730_field&quot;, 
    &quot;text&quot;: &quot;The patient has a fever&quot;
  }]
}
</code></pre></div>
<p>An <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview">Azure function</a> is made up of three key files. They are kept in the function's directory (<code>app/workers/...</code>) and define what and how the function should run:</p>
<ol>
<li><code>init.py</code> - This contains the function's logic. The method <code>main()</code> should be present for the function to execute.</li>
<li><code>function.json</code> - This tells Azure what type of function you're developing and also what queue from which to pick messages up from.</li>
</ol>
<p>Another file is kept outside of the function's directory and should not be commited to Git:</p>
<ol>
<li><code>local.settings.json</code> - Contains environment variables for your function. It must be present to run Azure functions locally. Contact a member of the development team to get all keys and connection strings for this file. For reference, a local.settings.json file looks like this:</li>
</ol>
<p><div class="highlight"><pre><span></span><code>{
  &quot;IsEncrypted&quot;: false,
  &quot;Values&quot;: {
    &quot;AzureWebJobsStorage&quot;: &quot;REDACTED,
    &quot;FUNCTIONS_WORKER_RUNTIME&quot;: &quot;python&quot;,
    &quot;STORAGE_CONN_STRING&quot;: &quot;REDACTED&quot;,
    &quot;NLP_API_KEY&quot;: &quot;REDACTED&quot;,
    &quot;APP_URL&quot;: &quot;REDACTED&quot;,
    &quot;AZ_FUNCTION_KEY&quot;: &quot;REDACTED&quot;,
    &quot;SCAN_REPORT_QUEUE_NAME&quot;: &quot;scanreports-local&quot;,
    &quot;NLP_QUEUE_NAME&quot;: &quot;nlpqueue-local&quot;

  }
}
</code></pre></div>
You only need to have 1 <code>local.settings.json</code> file for all functions within the Carrot-Mapper project. Note, 
however, that it should be updated with extra queue names if/when the project requires them.</p>
<h3 id="azure-functions-in-carrot-mapper">Azure Functions in Carrot-Mapper<a class="headerlink" href="#azure-functions-in-carrot-mapper" title="Permanent link">&para;</a></h3>
<p>The Carrot-Mapper project has several different Azure Functions: one for processing scan reports (called 
<code>ProcessQueue</code> which posts to the message queue called <code>scanreports</code>), another to run the NLP service 
(called <code>NLPQueue</code> which posts to the message queue called <code>nlpqueue</code>), and one to generate mapping rules for a scan report. The code for these functions lives 
in the <code>/workers</code> directory.</p>
<h2 id="azure-functions-queues">Azure Functions Queues<a class="headerlink" href="#azure-functions-queues" title="Permanent link">&para;</a></h2>
<p>For each process (NLP and Scan Reports), we have two queues each - a 'local' queue and a 'live' queue 
(for a total of 4 unique queues.) As environment variables, they are encoded as:</p>
<h5 id="local-queues">Local queues<a class="headerlink" href="#local-queues" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>NLP_QUEUE_NAME=nlpqueue-local
SCAN_REPORT_QUEUE_NAME=scanreports-local
</code></pre></div>
<h5 id="deployed-queues">Deployed queues<a class="headerlink" href="#deployed-queues" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>NLP_QUEUE_NAME=nlpqueue
SCAN_REPORT_QUEUE_NAME=scanreports
</code></pre></div>
<p>The purpose of the local queues is that, when developing locally, messages are sent only to a 'local' queue. </p>
<p>These environment variables which control where messages are sent must be maintained in the following locations:</p>
<ol>
<li><code>local.settings.json</code> - A local file to hold Azure Function environment variables. Should point to 'local' 
(e.g. <code>NLP_QUEUE_NAME=nlpqueue-local</code>). </li>
<li>Within the Carrot webapp, the <code>.env</code> file must include variables for 'local' on your local machine and set to 
'live' variables on App Service.</li>
</ol>
<h2 id="running-azure-functions-locally">Running Azure Functions Locally<a class="headerlink" href="#running-azure-functions-locally" title="Permanent link">&para;</a></h2>
<p>We use Azurite to enable running the functions locally, emulating the Azure Function services.</p>
<p>To start debugging locally in VSCode you must first ensure that Carrot is up and running locally 
(<a href="https://github.com/Health-Informatics-UoN/CaRROT-Mapper#readme">see here for building and running the Carrot-Mapper Docker image</a> ). 
Once your local server is running, you can start Azure Function's debugging mode by clicking: </p>
<p>Run (top toolbar) -&gt; Start Debugging</p>
<p>After a few seconds, you'll see something like the following printed to the debugging terminal that's 
started when you run debugging:</p>
<p><div class="highlight"><pre><span></span><code>&gt; Executing task: . .venv/bin/activate &amp;&amp; func host start &lt;

Found Python version 3.9.5 (python3).

Azure Functions Core Tools
Core Tools Version:       3.0.3477 Commit hash: 5fbb9a76fc00e4168f2cc90d6ff0afe5373afc6d  (64-bit)
Function Runtime Version: 3.0.15584.0

[2021-07-02T09:34:28.929Z] Cannot create directory for shared memory usage: /dev/shm/AzureFunctions
[2021-07-02T09:34:28.929Z] System.IO.FileSystem: Access to the path &#39;/dev/shm/AzureFunctions&#39; is denied. Operation not permitted.

Functions:

        NLPQueue: queueTrigger
        ProcessQueue: queueTrigger

For detailed output, run func with --verbose flag.
[2021-07-02T09:34:32.711Z] Traceback (most recent call last):
[2021-07-02T09:34:32.711Z]   File &quot;/usr/local/Cellar/azure-functions-core-tools@3/3.0.3477/workers/python/3.9/OSX/X64/azure_functions_worker/bindings/shared_memory_data_transfer/file_accessor_unix.py&quot;, line 127, in _get_valid_mem_map_dirs
[2021-07-02T09:34:32.711Z]     os.makedirs(dir_path)
[2021-07-02T09:34:32.711Z]   File &quot;/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/os.py&quot;, line 215, in makedirs
[2021-07-02T09:34:32.711Z]     makedirs(head, exist_ok=exist_ok)
[2021-07-02T09:34:32.711Z]   File &quot;/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/os.py&quot;, line 225, in makedirs
[2021-07-02T09:34:32.711Z]     mkdir(name, mode)
[2021-07-02T09:34:32.711Z] PermissionError: [Errno 1] Operation not permitted: &#39;/dev/shm&#39;
[2021-07-02T09:34:32.812Z] Worker process started and initialized.
[2021-07-02T09:34:36.731Z] Host lock lease acquired by instance ID &#39;000000000000000000000000DC4198B8&#39;.
</code></pre></div>
You'll likely see a few errors/warnings about directories and permissions. At the time of writing this guide, it's safe to ignore these!
Note that two functions are listed as you start debugging mode: <code>NLPQueue</code> and <code>ProcessQueue</code>. 
These are the names of the <strong><em>directories</em></strong> which hold the function's code, not the name of the 
<strong><em>message queue</em></strong> which holds the function's messages. The text after the function name (queueTrigger) 
specifies the <em>type</em> of function it is (defined in <code>function.json</code>).
For more information on Function types, click <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview">here</a>.</p>
<p>With the final console output saying 'Host lock lease acquired', you're ready to run your first Azure Functions job!</p>
<h3 id="running-an-nlp-task">Running an NLP task<a class="headerlink" href="#running-an-nlp-task" title="Permanent link">&para;</a></h3>
<p>The remainder of this guide will show what to expect to see in the debugging console if you run NLP at the field level.</p>
<ol>
<li>Navigate to a field within a scan report.</li>
<li>Ensure the field you've chosen has a meaningful description (e.g. "Patient has a cold"). If it doesn't have one, 
click 'Edit Field' and manually put one in.</li>
<li>Ensure that <code>pass_from_source</code> is set to <code>True</code> within the field's settings. This will cause CCOM to process the field only.</li>
<li>Click 'Run NLP'</li>
<li>After a short wait a green message banner will appear to say NLP is now running.</li>
</ol>
<p>Hop back to VSCode. After a few seconds, you should see the debugging console updating to say that it has 
received the message from the message queue:
<div class="highlight"><pre><span></span><code>Executing &#39;Functions.NLPQueue&#39; (Reason=&#39;New queue message detected on &#39;nlpqueue-local&#39;.&#39;, Id=ea27d6be-eb0b-490c-9cab-82cf2a119355)
Trigger Details: MessageId: f00a438f-9bad-4110-bb8b-5278461d7bb3, DequeueCount: 1, InsertionTime: 2021-07-02T10:57:26.000+00:00
</code></pre></div>
If you have configured <code>.env</code> and <code>local.settings.json</code> correctly, you will see that the job was posted to the queue <code>nlpqueue-local</code>.</p>
<p>After some time (around 15-30 seconds), you should notice further updates to the debugging console. Due to various <code>print()</code> statements in the init.py file (remember, this holds the function's logic), the console will start logging what's occurring as the function processes the message in the message queue. First, the console shows you what message was sent to the queue:
<div class="highlight"><pre><span></span><code>MESSAGE &gt;&gt;&gt;  {&#39;id&#39;: &#39;f00a438f-9bad-4110-bb8b-5278461d7bb3&#39;, &#39;body&#39;: &#39;{&quot;documents&quot;: [{&quot;language&quot;: &quot;en&quot;, &quot;id&quot;: &quot;17569_field&quot;, &quot;text&quot;: &quot;patient has a cold&quot;}]}&#39;}
</code></pre></div>
After job submission, the <code>NLPQueue</code> function works through the stages detailed in <a href="../NlpQueue/">NLP Processing</a>. Having received concept <strong><em>codes</em></strong> from the NLP API, the function looks up a standard and valid <strong><em>conceptID</em></strong> using the CCOM API. Sometimes, a concept code will be returned which doesn't have a standard and valid conceptID. In such instances you will see the following in the debugging console:
<div class="highlight"><pre><span></span><code>Concept Code C34500 not found!
</code></pre></div>
However, if a standard and valid conceptID is found, the Azure function then saves the data to the <code>ScanReportConcept</code> model. This is shown to you in the debugging console with the <code>PAYLOAD</code> print statement like so:
<div class="highlight"><pre><span></span><code>SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;ICD10CM&#39;, &#39;nlp_concept_code&#39;: &#39;J00&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;ICD9CM&#39;, &#39;nlp_concept_code&#39;: &#39;460&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;SNOMEDCT_US&#39;, &#39;nlp_concept_code&#39;: &#39;82272006&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
</code></pre></div>
Here, three conceptIDs were found for three different vocabularies (ICD10CM, ICD9CM and SNOWMEDCT_US). Therefore, three records are saved to <code>ScanReportConcepts</code> (hence the three <code>SAVING TO FIELD LEVEL...</code> statements)</p>
<p>After successful execution, the debug console will finally tell you that the job has finished:
<div class="highlight"><pre><span></span><code>Executed &#39;Functions.NLPQueue&#39; (Succeeded, Id=ea27d6be-eb0b-490c-9cab-82cf2a119355, Duration=30234ms)
</code></pre></div></p>
<p>Here is a full interrupted trace of the above process:
<div class="highlight"><pre><span></span><code>Executing &#39;Functions.NLPQueue&#39; (Reason=&#39;New queue message detected on &#39;nlpqueue-local&#39;.&#39;, Id=ea27d6be-eb0b-490c-9cab-82cf2a119355)
Trigger Details: MessageId: f00a438f-9bad-4110-bb8b-5278461d7bb3, DequeueCount: 1, InsertionTime: 2021-07-02T10:57:26.000+00:00
MESSAGE &gt;&gt;&gt;  {&#39;id&#39;: &#39;f00a438f-9bad-4110-bb8b-5278461d7bb3&#39;, &#39;body&#39;: &#39;{&quot;documents&quot;: [{&quot;language&quot;: &quot;en&quot;, &quot;id&quot;: &quot;17569_field&quot;, &quot;text&quot;: &quot;patient has a cold&quot;}]}&#39;}
Concept Code C34500 not found!
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;ICD10CM&#39;, &#39;nlp_concept_code&#39;: &#39;J00&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;ICD9CM&#39;, &#39;nlp_concept_code&#39;: &#39;460&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;SNOMEDCT_US&#39;, &#39;nlp_concept_code&#39;: &#39;82272006&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
Executed &#39;Functions.NLPQueue&#39; (Succeeded, Id=ea27d6be-eb0b-490c-9cab-82cf2a119355, Duration=30234ms)
</code></pre></div></p>
<h3 id="stopping-debugging">Stopping Debugging<a class="headerlink" href="#stopping-debugging" title="Permanent link">&para;</a></h3>
<p>Debugging can be stopped by clicking:</p>
<p>Run (top menu) -&gt; Stop Debugging</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
 
        
      </div>
      <div class="md-social">
  
</div>
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.tracking", "navigation.indexes", "navigation.top", "content.action.edit"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3220b9d7.min.js"></script>
      
    
  </body>
</html>