
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.18">
    
    
      
        <title>UploadQueue - Carrot Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="carrot" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Carrot Docs" class="md-header__button md-logo" aria-label="Carrot Docs" data-md-component="logo">
      
  <img src="../../images/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Carrot Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              UploadQueue
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Health-Informatics-UoN/carrot-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Health-Informatics-UoN/carrot-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Carrot Docs" class="md-nav__button md-logo" aria-label="Carrot Docs" data-md-component="logo">
      
  <img src="../../images/favicon.png" alt="logo">

    </a>
    Carrot Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Health-Informatics-UoN/carrot-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Health-Informatics-UoN/carrot-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#triggering-the-function" class="md-nav__link">
    <span class="md-ellipsis">
      Triggering the function
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Triggering the function">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-scanreport-object" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a ScanReport object
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-to-azure-account" class="md-nav__link">
    <span class="md-ellipsis">
      Connect to Azure Account
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-unique-file-names" class="md-nav__link">
    <span class="md-ellipsis">
      Create unique file names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-dictionary" class="md-nav__link">
    <span class="md-ellipsis">
      Create dictionary
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-data-to-azure-blob-storage" class="md-nav__link">
    <span class="md-ellipsis">
      Upload data to Azure blob storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#submit-message-to-azure-queue" class="md-nav__link">
    <span class="md-ellipsis">
      Submit message to Azure queue
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-function-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Azure Function Operation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Azure Function Operation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accessing-the-file" class="md-nav__link">
    <span class="md-ellipsis">
      Accessing the File
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing" class="md-nav__link">
    <span class="md-ellipsis">
      Processing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Processing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scan-report-table" class="md-nav__link">
    <span class="md-ellipsis">
      Scan Report Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scan-report-field" class="md-nav__link">
    <span class="md-ellipsis">
      Scan Report Field
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scan-report-value" class="md-nav__link">
    <span class="md-ellipsis">
      Scan Report Value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-dictionary-creation" class="md-nav__link">
    <span class="md-ellipsis">
      Data Dictionary Creation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/Health-Informatics-UoN/carrot-docs/edit/main/docs/AzureFunctions/UploadQueue.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page is for developers of Azure Functions - not users</p>
</div>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p><strong>UploadQueue</strong> refers to an Azure Queue Trigger function which processes and saves a scan report and data dictionary to the Carrot database. It is also the name of the directory in the webapp's root directory which houses the Azure Function code. The function is triggered when a new message is added to the queue. Messages are added to the queue when a user uploads a Scan Report and Data Dictionary to the webapp.</p>
<p>This guide documents the process when a scan report <strong>and</strong> and a data dictionary are uploaded to the system (i.e. the most complex scenario). Note, however, that a user can choose to upload a scan report without a data dictionary. The code snippets below have been extracted from <code>ScanReportFormView</code> in <code>views.py</code>. The snippets contain only the key code to illustrate a point/functionality, rather than offering the full FormView class code required for successful execution. Please refer to <code>api/views.py</code> for unabridged code.</p>
<h2 id="triggering-the-function">Triggering the function<a class="headerlink" href="#triggering-the-function" title="Permanent link">&para;</a></h2>
<p>The function is triggered when a White Rabbit Scan Report file and a data dictionary are uploaded on the webapp. The code in <code>ScanReportFormView</code> carries out the following steps after form submission and during form validation:</p>
<ol>
<li>Creates a new object in the <code>ScanReport</code> model</li>
<li>Connects to our Azure account</li>
<li>Creates unique file names for the scan report and data dictionary</li>
<li>Creates a dictionary holding the ScanReport model object and file names from Step 3 called <code>azure_dict</code></li>
<li>Uploads data to our Azure blob storage accounts (<code>scan-reports</code> and <code>data-dictionaries</code>) using the connecting string from Step 2</li>
<li>Submits <code>azure_dict</code> to the message queue so the Azure function using the connection string from Step 2. This messages is requires so the function ca get the correct files from Azure blob storage</li>
</ol>
<p>After  uploading the raw data and submitting a message to the queue, views.py doesn't carry out any further code execution - the online Azure function takes over, processes the scan report and dictionary (more on this below) and then POSTs the data back to the webapp via the Carrot API using the <code>requests</code> library. </p>
<h3 id="creating-a-scanreport-object">Creating a <code>ScanReport</code> object<a class="headerlink" href="#creating-a-scanreport-object" title="Permanent link">&para;</a></h3>
<p>We create a model object in <code>ScanReport</code> so that tables, fields and values can later be associated with the correct scan report (as the scan report/dictionary is processed within the Azure Function and POST'd back to the webapp.)</p>
<div class="highlight"><pre><span></span><code><span class="n">scan_report</span> <span class="o">=</span> <span class="n">ScanReport</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">data_partner</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;data_partner&quot;</span><span class="p">],</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>
<h3 id="connect-to-azure-account">Connect to Azure Account<a class="headerlink" href="#connect-to-azure-account" title="Permanent link">&para;</a></h3>
<p>We connect to our Azure account with the following:</p>
<div class="highlight"><pre><span></span><code><span class="n">blob_service_client</span> <span class="o">=</span> <span class="n">BlobServiceClient</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;STORAGE_CONN_STRING&#39;</span><span class="p">))</span>
</code></pre></div>
<p>Note that <code>STORAGE_CONN_STRING</code> has to be set either in your .env file when developing locally or within the the Azure Portal. See Sam/Vas for more details on where environment variables are kept online.</p>
<h3 id="create-unique-file-names">Create unique file names<a class="headerlink" href="#create-unique-file-names" title="Permanent link">&para;</a></h3>
<p>We create unique datetime and random alphanumeric strings to append to the file names of the scan report and data dictionary:</p>
<p><div class="highlight"><pre><span></span><code><span class="n">rand</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
<span class="n">dt</span> <span class="o">=</span> <span class="s1">&#39;{:%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S_}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div>
We do this so that if we ever need to cross-reference a particular scan report with a particular data dictionary, we can easily see (1) when the files were upload (specifed with <code>dt</code>) and (2) what dictionary belongs to which scan report (unique alphanumeric string defined in <code>rand</code>)</p>
<h3 id="create-dictionary">Create dictionary<a class="headerlink" href="#create-dictionary" title="Permanent link">&para;</a></h3>
<p>We then create a dictionary containing:
1. The newly created scan report ID 
2. Unique scan report file name
3. Unique data dictionary nam
<div class="highlight"><pre><span></span><code><span class="n">azure_dict</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;scan_report_id&quot;</span><span class="p">:</span><span class="n">scan_report</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="s2">&quot;scan_report_blob&quot;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan_report_file&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">dt</span><span class="o">+</span><span class="n">rand</span><span class="o">+</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data_dictionary_blob&quot;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_dictionary_file&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">dt</span><span class="o">+</span><span class="n">rand</span><span class="o">+</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></p>
<h3 id="upload-data-to-azure-blob-storage">Upload data to Azure blob storage<a class="headerlink" href="#upload-data-to-azure-blob-storage" title="Permanent link">&para;</a></h3>
<p>We then upload our data to Azure blob storage. Scan reports go to the container called <code>scan-reports</code> and data dictionaries go to the container called <code>data-dictionaries</code>. </p>
<div class="highlight"><pre><span></span><code><span class="n">blob_client</span> <span class="o">=</span> <span class="n">blob_service_client</span><span class="o">.</span><span class="n">get_blob_client</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="s2">&quot;scan-reports&quot;</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan_report_file&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">dt</span><span class="o">+</span><span class="n">rand</span><span class="o">+</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">)</span>
<span class="n">blob_client</span><span class="o">.</span><span class="n">upload_blob</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan_report_file&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">())</span>
<span class="n">blob_client</span> <span class="o">=</span> <span class="n">blob_service_client</span><span class="o">.</span><span class="n">get_blob_client</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="s2">&quot;data-dictionaries&quot;</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_dictionary_file&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">dt</span><span class="o">+</span><span class="n">rand</span><span class="o">+</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
<span class="n">blob_client</span><span class="o">.</span><span class="n">upload_blob</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_dictionary_file&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">())</span>
</code></pre></div>
<h3 id="submit-message-to-azure-queue">Submit message to Azure queue<a class="headerlink" href="#submit-message-to-azure-queue" title="Permanent link">&para;</a></h3>
<p>We then encode and submit the message defined in <code>azure_dict</code> to the Azure message queue:
<div class="highlight"><pre><span></span><code><span class="n">queue_message</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">azure_dict</span><span class="p">)</span>
<span class="n">message_bytes</span> <span class="o">=</span> <span class="n">queue_message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
<span class="n">base64_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">message_bytes</span><span class="p">)</span>
<span class="n">base64_message</span> <span class="o">=</span> <span class="n">base64_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>

<span class="n">queue</span> <span class="o">=</span> <span class="n">QueueClient</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span>
  <span class="n">conn_str</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;STORAGE_CONN_STRING&quot;</span><span class="p">),</span>
  <span class="n">queue_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SCAN_REPORT_QUEUE_NAME&quot;</span><span class="p">)</span>
  <span class="p">)</span>
<span class="n">queue</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">base64_message</span><span class="p">)</span>
</code></pre></div>
Once the message has been sent, the Azure Function will automatically pick up the message and execute the code in <code>__init__.py</code>. Using the data in the message, the function will know what files to grab from blob storage for processing. By defining <code>scan_report_id</code> the function knows how to relate newly created tables, fields and values to the correct scan report.</p>
<h1 id="azure-function-operation">Azure Function Operation<a class="headerlink" href="#azure-function-operation" title="Permanent link">&para;</a></h1>
<h2 id="accessing-the-file">Accessing the File<a class="headerlink" href="#accessing-the-file" title="Permanent link">&para;</a></h2>
<p>As soon as the ProcessQueue is triggered it uses <code>scan_report_blob</code> and <code>data_dictionary_blob</code> from the message body to download the correct files from Azure Blob Storage into a BytesIO() object.</p>
<p>The message body is accessed via:
<div class="highlight"><pre><span></span><code><span class="c1"># Get message from queue</span>
<span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_body</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
        <span class="s2">&quot;expiration_time&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">expiration_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">expiration_time</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">),</span>
        <span class="s2">&quot;insertion_time&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">insertion_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">insertion_time</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">),</span>
        <span class="s2">&quot;time_next_visible&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">time_next_visible</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">time_next_visible</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">),</span>
        <span class="s2">&quot;pop_receipt&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">pop_receipt</span><span class="p">,</span>
        <span class="s2">&quot;dequeue_count&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">dequeue_count</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Grab message body from storage queues, </span>
<span class="c1"># extract filenames for scan reports and dictionaries</span>
<span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
<span class="n">scan_report_blob</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;scan_report_blob&quot;</span><span class="p">]</span>
<span class="n">data_dictionary_blob</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;data_dictionary_blob&quot;</span><span class="p">]</span>
</code></pre></div>
The files are accessed from blob storage with the following code:
<div class="highlight"><pre><span></span><code><span class="c1"># Grab scan report data from blob</span>
<span class="n">container_client</span> <span class="o">=</span> <span class="n">blob_service_client</span><span class="o">.</span><span class="n">get_container_client</span><span class="p">(</span><span class="s2">&quot;scan-reports&quot;</span><span class="p">)</span>
<span class="n">blob_scanreport_client</span> <span class="o">=</span> <span class="n">container_client</span><span class="o">.</span><span class="n">get_blob_client</span><span class="p">(</span><span class="n">scan_report_blob</span><span class="p">)</span>
<span class="n">streamdownloader</span> <span class="o">=</span> <span class="n">blob_scanreport_client</span><span class="o">.</span><span class="n">download_blob</span><span class="p">()</span>
<span class="n">scanreport</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">streamdownloader</span><span class="o">.</span><span class="n">readall</span><span class="p">())</span>

<span class="c1"># Grab data dictionary data from blob</span>
<span class="n">container_client</span> <span class="o">=</span> <span class="n">blob_service_client</span><span class="o">.</span><span class="n">get_container_client</span><span class="p">(</span><span class="s2">&quot;data-dictionaries&quot;</span><span class="p">)</span>
<span class="n">blob_dict_client</span> <span class="o">=</span> <span class="n">container_client</span><span class="o">.</span><span class="n">get_blob_client</span><span class="p">(</span><span class="n">data_dictionary_blob</span><span class="p">)</span>
<span class="n">streamdownloader</span> <span class="o">=</span> <span class="n">blob_dict_client</span><span class="o">.</span><span class="n">download_blob</span><span class="p">()</span>
<span class="n">data_dictionary</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">streamdownloader</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()))</span>
</code></pre></div></p>
<h2 id="processing">Processing<a class="headerlink" href="#processing" title="Permanent link">&para;</a></h2>
<p>The next stage is to step through the Excel workbook and create model entries for each <strong>ScanReportTable</strong>, <strong>ScanReportField</strong> and <strong>ScanReportValue</strong> present in the file.</p>
<h3 id="scan-report-table">Scan Report Table<a class="headerlink" href="#scan-report-table" title="Permanent link">&para;</a></h3>
<p>The <strong>Field Overview</strong> sheet in a White Rabbit Scan Report has a 'Table' column which seperates different table names using a blank row. ProcessQueue main method iterates through the rows in the 'Table' column and appends each unique table name to the list <code>table_names</code>. 
For each table in <code>table_names</code> a new <code>ScanReportTable</code> entry is generated. The table entries are linked to the <code>ScanReport</code> model using the <code>scan_report_id</code> from the queue message body.
The table entries are then appended to a JSON array <code>json_data</code> which forms the input send in a POST request to the <a href="../../Carrot-Mapper/API/">API</a>.
The API automatically generates the <code>id</code> for each table that was created. These ids are extracted from the POST request response and saved in a list (<code>table_ids</code>)</p>
<h3 id="scan-report-field">Scan Report Field<a class="headerlink" href="#scan-report-field" title="Permanent link">&para;</a></h3>
<p><strong>Field Overview</strong> contains all the information on the fields including the name, description and other useful columns. ProcessQueue iterates through the rows in the sheet and generates a new <code>ScanReportField</code> entry.
Once it detects an empty line (end of a table) it saves the fields found in that table.
This is done by appending the field entries to a JSON array <code>json_data</code>, which forms the input to a POST request made to the <a href="../../Carrot-Mapper/API/">API</a>. From the response it saves the <code>field_ids</code> and <code>field_names</code> and stores them into a dictionary as key value pairs e.g "Field Name": Field ID.</p>
<h3 id="scan-report-value">Scan Report Value<a class="headerlink" href="#scan-report-value" title="Permanent link">&para;</a></h3>
<p>Scan report values are stored in sheets named after their corresponding table. Once the fields in a table are saved, it moves to the corresponding sheet (where the sheet is the same as the table_name) and the <code>process_scan_report_sheet_table()</code> function is called on that worksheet. The function extracts the data in the following format:</p>
<p><strong>Input</strong></p>
<table>
<thead>
<tr>
<th>ID</th>
<th>Frequency</th>
<th>Date</th>
<th>Frequency</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>20</td>
<td>02/12/2020</td>
<td>5</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>12/11/2020</td>
<td>37</td>
</tr>
</tbody>
</table>
<p><strong>Output</strong></p>
<p>(ID, 1, 20)
(Date, 02/12/2020, 5)
(ID, 2, 3)
(Date, 12/11/2020, 37)</p>
<p>A ScanReportValue entry is generated by iterating through the output of <code>process_scan_report_sheet_table()</code>. The value entries are linked to the <code>ScanReportField</code> model using the function output and the dictionary with all the field names and ids. Same as with the other two models the value entries are appended to a JSON array <code>json_data</code>, and form the input to a POST request made to the <a href="../../Carrot-Mapper/API/">API</a>.</p>
<h3 id="data-dictionary-creation">Data Dictionary Creation<a class="headerlink" href="#data-dictionary-creation" title="Permanent link">&para;</a></h3>
<p>If a user uploads a data dictionary, there is a small subroutine during the <code>ScanReportValue</code> code which matches the scan report value name against the supplied data dictionary. If there's a match, the code saves the dictionary's value description to the <code>value_description</code> field in the <code>ScanReportValue</code> model:</p>
<div class="highlight"><pre><span></span><code><span class="n">val_desc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;value_description&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_dictionary</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;field_name&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
 
        
      </div>
      <div class="md-social">
  
</div>
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.tracking", "navigation.indexes", "navigation.top", "content.action.edit"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3220b9d7.min.js"></script>
      
    
  </body>
</html>